# 路由机制（已集成）

`router.rs` 已与服务器生命周期集成，支持数据消息的多跳路由与广播。本文档说明路由模块的设计、集成点、消息格式、测试与使用方法。

## 概览

- 支持基于 `RoutingTable` 的下一跳选择与广播兜底。
- 握手与发现响应会更新路由表；断连会移除相关路由。
- 内置消息去重缓存与定期清理，避免环路与重复转发。
- 提供服务器侧 API `P2PServer::send_routed_data` 进行定向路由发送。

## 关键组件

- `RoutingTable`
  - 维护 `目的节点ID -> 下一跳节点ID` 与 `距离` 映射。
  - 仅在新距离更短时更新，支持移除指定目的地与指定下一跳的所有路由。
- `MessageRouter`
  - `route_message`：目标为本地则直接处理，否则封装并转发。
  - `forward_message`：执行去重、TTL（`max_hops`）、下一跳选择或广播。
  - `broadcast_message`：对所有已认证节点广播（跳过源节点）。
  - `handle_local_message`：目标为本地时的处理逻辑（目前打印日志）。
  - `update_routing_table` / `remove_node_routes` / `get_routing_table_snapshot`。
  - 消息缓存：`is_message_cached`、`cache_message_id` 与 `start_cache_cleanup_task`。
- `PeerManager`
  - 管理对等节点的添加、认证状态与连接；路由广播面向其“已认证”集合。
- `P2PServer`
  - 在握手成功时登记直连路由（距离=1）。
  - 在接收 `DiscoveryResponse` 时登记邻居宣告的二级路由（距离=2）。
  - 在接收 `Data` 时尝试路由；在断连时清理路由。
  - 暴露 `send_routed_data` 供外部调用进行定向发送。

## 路由消息格式

路由采用在 `MessageType::Data` 中封装 `RoutedMessage` 的方式进行转发：

```json
{
  "message_type": "Data",
  "payload": {
    "original_message": { /* 原始业务消息 */ },
    "source_node": "uuid",
    "destination_node": "uuid",
    "hop_count": 1,
    "max_hops": 10,
    "route_id": "uuid"
  }
}
```

- `hop_count` 在每次转发时递增，超过 `max_hops` 将终止。
- `route_id` 用于去重缓存，防止重复处理与环路扩散。

## 工作流程（服务器集成）

- 握手成功（`HandshakeResponse`）
  - 为该对等登记直连路由：`distance = 1`，下一跳为该对等。
- 节点发现（`DiscoveryResponse`）
  - 为对端宣告的其他节点登记二级路由：`distance = 2`，下一跳为该对端。
- 数据消息（`Data`）
  - 目标为本地：本地处理。
  - 无下一跳：广播至所有已认证节点（跳过源）。
  - 下一跳不可达：移除相关路由后广播。
- 断连（`Disconnect` 或非正常断开）
  - 移除以该节点为目的地的路由以及经该节点的所有路由。

## 使用示例（服务器侧定向发送）

在 `P2PServer` 中提供：

```rust
pub async fn send_routed_data(
    &self,
    destination_node: uuid::Uuid,
    payload: serde_json::Value,
    max_hops: u32,
) -> anyhow::Result<()>
```

示例调用：

```rust
server.send_routed_data(
    target_node_id,
    serde_json::json!({"msg":"hello"}),
    8,
).await?;
```

## 测试与验证

项目内置路由模块的异步端到端测试（`src/router.rs`）：

- `test_forward_via_next_hop`
  - 搭建本地与下一跳的 UDP 套接字，设置路由，验证对端收到封装的 `Data`。
- `test_broadcast_when_no_route`
  - 无路由情况，验证两个对端均收到广播的数据消息。
- `test_unreachable_next_hop_removes_route_and_broadcasts`
  - 设置不可达的下一跳后调用路由，断言路由被移除且广播生效。

运行：

```bash
cargo test
```

日志建议设置 `RUST_LOG=debug` 便于观察路由行为与广播结果。

## 注意事项与后续计划

- 目前本地数据处理（`handle_local_message`）仅记录日志，可按需扩展业务处理。
- 可引入更丰富的路由发现与距离度量（RTT/丢包/评分），动态更新最优路径。
- 可补充示例程序演示多节点互通与路由可视化。