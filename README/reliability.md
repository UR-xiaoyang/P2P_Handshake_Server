# 可靠性机制（UDP）

UDP 是无连接且不保证可靠的传输方案。为确保在关键场景下的可靠性，本项目在应用层引入了以下机制：

## 1. ACK 确认

- 每条消息可通过 `requires_ack = true` 请求对方返回确认。
- 接收方在成功解析并接受消息后，返回 `Ack`：

```json
{
  "message_type": "Ack",
  "ack_for": 42,
  "timestamp": 1234567892,
  "sender_addr": "127.0.0.1:8080"
}
```

- `ack_for` 指向被确认消息的 `sequence_number`。

## 2. 序列号与去重

- 发送方为需要可靠性的消息分配递增的 `sequence_number`。
- 接收方维护近期序号的缓存窗口，忽略重复包，保证处理幂等。

## 3. 重传（Retransmit）

- 若在超时时间内未收到 `Ack`，可发送 `Retransmit` 请求或直接重发原消息。
- 推荐策略（可根据实际场景调整）：
  - 初始超时：`500ms`
  - 最大重试：`3` 次
  - 退避算法：指数退避（如 `500ms`, `1s`, `2s`）

示例重传请求：

```json
{
  "message_type": "Retransmit",
  "payload": { "sequence_number": 42 },
  "timestamp": 1234567893
}
```

## 4. 乱序与丢包

- UDP 包可能乱序到达。处理方应以 `sequence_number` 与消息类型驱动逻辑，而非假设顺序。
- 对关键流程（握手/认证/重要数据），合理使用 `requires_ack` 与重传策略。

## 5. NAT 与端口变化

- 对等节点以 `SocketAddr` 标识；若客户端重启或 NAT 变化导致源端口变化，应视为新的对等地址并重新握手。

## 6. 安全与限流

- 建议对 `requires_ack` 消息施加速率限制，避免 ACK 风暴。
- 对 `Retransmit` 请求做来源校验；仅接受来自已知对等的重传请求。

## 7. 日志与观测

- 在 `debug` 级别下，系统会记录收发与类型处理日志，便于观察 ACK/重传行为。
- 建议优先使用命令行参数设置日志级别（如 `--INFO`、`--DEBUG`、`--TRACE`）；未指定时可使用环境变量 `RUST_LOG`。
- 生产环境可降低日志级别，减少对性能与磁盘的影响。