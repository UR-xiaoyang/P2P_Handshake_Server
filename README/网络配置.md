# `network_id`：网络隔离与配置

`network_id` 是本 P2P 系统中一个至关重要的概念，它用于实现网络隔离、确保安全性和维护网络纯净性。本文档将详细解释其作用、配置方法以及未来的发展方向。

## 作用：网络隔离的“通行证”

您可以将 `network_id` 想象成一个特定 P2P 网络的“通行证”或“暗号”。握手服务器在处理客户端的 `HandshakeRequest` 时，会严格校验客户端提供的 `network_id` 是否与服务器自身配置的 `network_id` 相匹配。

这种机制带来了几个核心优势：

1.  **隔离不同网络**：您可以同时运行多个独立的 P2P 网络（例如，生产环境、测试环境、开发环境），每个网络使用不同的 `network_id`。这可以有效防止一个网络中的节点意外连接到另一个网络，避免数据污染或服务中断。
    *   生产网络：`network_id: "prod-mainnet"`
    *   测试网络：`network_id: "test-sidechain"`

2.  **安全性**：`network_id` 提供了一层基础的访问控制。只有知道正确 `network_id` 的节点才能成功通过握手服务器的验证并加入网络，这可以阻止未经授权或配置错误的节点接入。

## 配置方法

服务器的 `network_id` 是在启动时加载的。加载逻辑如下：

1.  **通过配置文件加载（推荐）**：
    在启动服务器时，使用 `--config` 或 `-c` 参数指定一个配置文件（如 `config.json`）。服务器会从该文件中读取 `network_id`。

    **`config.json` 示例：**
    ```json
    {
      "listen_address": "127.0.0.1:8080",
      "max_connections": 100,
      "network_id": "test-net"
    }
    ```

    **启动命令：**
    ```powershell
    cargo run -- --config config.json
    ```
    在这种模式下，服务器期望的 `network_id` 将是 `"test-net"`。

2.  **使用默认值（未指定配置文件时）**：
    如果在启动时**未**指定配置文件，服务器将使用代码中硬编码的默认值。在 `src/config.rs` 的 `Config::new()` 函数中，这个默认值被设置为 `"p2p_default"`。

    **启动命令：**
    ```powershell
    cargo run
    ```
    在这种模式下，服务器期望的 `network_id` 将是 `"p2p_default"`。

> **重要提示**：如果您修改了 `config.json` 文件，必须**重启服务器**才能使新的配置生效。服务器不会动态热加载配置文件。

## 常见问题：“网络ID不匹配”错误

如果您在服务器日志中看到 `网络ID不匹配: 期望 <A>，收到 <B>` 的错误，这几乎总是意味着：
*   服务器加载的 `network_id` 是 `<A>`。
*   客户端发送的 `network_id` 是 `<B>`。
*   这通常是因为服务器启动时没有加载正确的配置文件，或者客户端与服务器的配置不一致。

**解决方法**：
1.  确认服务器启动时是否使用了 `--config config.json` 参数。
2.  检查 `config.json` 文件中的 `network_id` 是否与客户端发送的一致。
3.  重启服务器以加载最新的配置。

## 未来展望：支持多网络引导

当前架构下，一个服务器实例只能为一个 `network_id` 提供服务。未来的一个重要发展方向是让服务器能够**同时为多个网络提供引导服务**。

**设计构想**：
*   移除服务器的全局 `network_id` 配置。
*   服务器内部维护一个按 `network_id` 划分的动态节点池。
*   当收到握手或发现请求时，服务器根据请求中的 `network_id` 在对应的节点池中进行操作。

这将大大提高服务器的灵活性和资源利用率，使其成为一个真正的多租户引导平台。